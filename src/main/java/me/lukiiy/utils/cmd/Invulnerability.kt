package me.lukiiy.utils.cmd

import com.mojang.brigadier.Command
import com.mojang.brigadier.tree.LiteralCommandNode
import io.papermc.paper.command.brigadier.CommandSourceStack
import io.papermc.paper.command.brigadier.Commands
import io.papermc.paper.command.brigadier.argument.ArgumentTypes
import me.lukiiy.utils.Defaults
import me.lukiiy.utils.Lukitils
import me.lukiiy.utils.help.Utils
import me.lukiiy.utils.help.Utils.asPermission
import me.lukiiy.utils.help.Utils.getPlayerOrThrow
import net.kyori.adventure.text.Component
import org.bukkit.command.CommandSender
import org.bukkit.entity.Player
import org.bukkit.event.EventHandler
import org.bukkit.event.Listener
import org.bukkit.event.entity.EntityDamageEvent

object Invulnerability : Listener {
    private val main = Commands.literal("invulnerability")
        .requires { it.sender.hasPermission("invulnerability".asPermission()) }
        .then(Commands.argument("player", ArgumentTypes.player())
            .executes {
                val target = it.getPlayerOrThrow("player")

                handle(it.source.sender, target)
                Command.SINGLE_SUCCESS
            })
        .executes {
            val sender = it.source.sender as? Player ?: throw Defaults.NON_PLAYER

            handle(sender, sender)
            Command.SINGLE_SUCCESS
        }

    fun register(): LiteralCommandNode<CommandSourceStack> = main.build()

    fun handle(sender: CommandSender, target: Player) {
        val update = !target.isInvulnerable
        val msg = Defaults.neutral(Component.text("Invulnerability is now ")).append(if (update) Defaults.ON else Defaults.OFF)
        var adminMsgExtra = ""

        target.isInvulnerable = update

        if (target != sender) {
            sender.sendMessage(msg.append(Component.text(" for ").append(target.name().color(Defaults.YELLOW))).color(Defaults.GRAY))

            if (!Lukitils.getInstance().config.getBoolean("silentStats", true)) target.sendMessage(msg.append(Component.text(" (by ").append(sender.name().color(Defaults.YELLOW)).append(Component.text(")"))).color(Defaults.GRAY))
            adminMsgExtra = "for ${target.name}"
        } else target.sendMessage(msg)

        Utils.adminCmdFeedback(sender, "${if (update) "Enabled" else "Disabled"} invulnerability $adminMsgExtra")
    }

    // Listener
    @EventHandler
    fun dmg(e: EntityDamageEvent) { // void + gm1 dmg
        if (e.entity is Player && e.entity.isInvulnerable) e.isCancelled = true
    }
}